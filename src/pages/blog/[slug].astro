---
export const prerender = false;

import { Image } from "astro:assets";
import { format } from "date-fns";
import type { PostType } from "../../types";

// 1. Extraemos el slug de la URL
const { slug } = Astro.params as { slug: string };

// 2. Fetch al endpoint de detalle (y aquí la API ya incrementa views)
const postRes = await fetch(`http://localhost:3000/api/posts/slug/${slug}`);
if (!postRes.ok) throw new Error(`Post no encontrado: ${slug}`);
const post: PostType = await postRes.json();

// 3. (Opcional) Traer posts populares
const popRes = await fetch(`http://localhost:3000/api/posts/popular?limit=5`);
const populares: PostType[] = popRes.ok ? await popRes.json() : [];
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{post.title} | Elipson Blog</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <!-- Banner con imagen del post y meta (avatar, autor, fecha, vistas) -->
    <section
      class="banner"
      style={`background-image: url('${post.imageUrl ?? "/fallback-post-image.png"}');`}
    >
      <div class="overlay">
        <div class="banner-meta">
          <Image
            src={post.author.avatarUrl ?? "/fallback-avatar.png"}
            alt={post.author.name}
            width={32}
            height={32}
            class="author-avatar"
          />
          <span class="author-name">By {post.author.name}</span>
          
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M3 8h18M7 4v4M17 4v4M5 20h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2z"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <time class="banner-date">
            {format(new Date(post.createdAt), "dd MMM yyyy")}
          </time>
          
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path
              d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            />
            <circle
              cx="12"
              cy="12"
              r="3"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            />
          </svg>
          <span class="banner-views">{post.views}</span>
        </div>
      </div>
    </section>

    <main class="post-detail container">
      <article class="post-content">
        <h1 class="detail-title">{post.title}</h1>
        <div class="detail-body" set:html={post.content} />
        
        <div class="detail-tags">
          {post.tags.map((tag) => (
            <a href={`/?tag=${encodeURIComponent(tag.name)}`} class="tag">
              {tag.name}
            </a>
          ))}
        </div>
      </article>

      <aside class="post-sidebar">
        <h2>Artículos Populares</h2>
        <ul class="popular-list">
          {populares.map((popular) => (
            <li>
              <a href={`/blog/${popular.slug}`} class="popular-item">
                <Image
                  src={popular.imageUrl ?? "/fallback-post-image.png"}
                  alt={popular.title}
                  width={48}
                  height={48}
                  class="popular-thumb"
                />
                <div class="popular-info">
                  <p class="popular-title">{popular.title}</p>
                  <span class="popular-author">{popular.author.name}</span>
                </div>
              </a>
              <hr />
            </li>
          ))}
        </ul>
      </aside>
    </main>
  </body>
</html>